@startuml
hide footbox
skinparam style strictuml
skinparam sequenceMessageAlign center
actor "User (UI)" as U
participant "API Gateway" as A
database "Registry" as R
participant "Privacy Guard" as P
participant "Meter/Rate" as M
participant "Exec Orchestrator" as X
database "DuckDB" as D
collections "Storage (Parquet/S3)" as S
queue "Audit/Usage" as L

U -> A: GET /plfs/data?state=MH&gender=female&age=15-29&group_by=state,gender
A -> M: Check rate + pre-usage caps
M --> A: OK / require billing token
A -> R: Load schema, filters, policies
A -> P: Validate filters; enforce aggregation/buckets
P --> A: Safe SQL or Reject
A -> X: Execute with timeout & pagination
X -> D: Run SQL (param bound)
D -> S: Pushdown filters; scan
S --> D: Columnar pages
D --> X: Rows + schema
X -> P: Apply k-anonymity cell suppression (k>=10)
P --> A: Suppressed rows + policy annotations
A -> M: Post-usage update (rows, bytes)
A -> L: Append audit {trace_id, sql_hash, caps}
A --> U: 200 JSON/CSV + meta {suppression, usage}

alt Caps exceeded & no billing token
  M --> A: Deny (LIMIT_EXCEEDED)
  A --> U: 402/429 with guidance
end
@enduml
